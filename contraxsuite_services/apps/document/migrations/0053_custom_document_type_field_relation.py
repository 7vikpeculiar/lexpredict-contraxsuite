# -*- coding: utf-8 -*-
# Generated by Django 1.11.3 on 2018-07-24 15:04
from __future__ import unicode_literals

from django.db import migrations, models
import django.db.models.deletion


def move_document_type_fields(apps, schema_editor):
    DocumentTypeField = apps.get_model('document', 'DocumentTypeField')
    DocumentType = apps.get_model('document', 'DocumentType')

    document_type_fields = []
    for document_type in DocumentType.objects.all():
        for field in document_type.fields.all():
            document_type_fields.append(DocumentTypeField(document_type=document_type, document_field=field))

    DocumentTypeField.objects.bulk_create(document_type_fields)


class Migration(migrations.Migration):
    dependencies = [
        ('document', '0052_documentfield_description'),
    ]

    operations = [
        migrations.CreateModel(
            name='DocumentTypeField',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('document_field',
                 models.ForeignKey(db_column='documentfield_id', on_delete=django.db.models.deletion.CASCADE,
                                   to='document.DocumentField')),
                ('document_type',
                 models.ForeignKey(db_column='documenttype_id', on_delete=django.db.models.deletion.CASCADE,
                                   to='document.DocumentType')),
                ('training_finished', models.BooleanField(default=False)),
                ('dirty', models.BooleanField(default=False)),
                ('modified_date', models.DateTimeField(auto_now=True)),
                ('created_date', models.DateTimeField(auto_now_add=True)),
            ],
        ),

        migrations.AlterUniqueTogether(
            name='documenttypefield',
            unique_together=set([('document_type', 'document_field')]),
        ),

        migrations.AddIndex(
            model_name='documenttypefield',
            index=models.Index(fields=['dirty'], name='document_do_dirty_0053a5_idx'),
        ),

        migrations.AddIndex(
            model_name='documenttypefield',
            index=models.Index(fields=['training_finished'], name='document_do_trainin_3020c4_idx'),
        ),

        migrations.AddIndex(
            model_name='documenttypefield',
            index=models.Index(fields=['modified_date'], name='document_do_modifie_f1f00f_idx'),
        ),

        migrations.RunPython(move_document_type_fields, reverse_code=migrations.RunPython.noop),

        migrations.RemoveField(
            model_name='documenttype',
            name='fields',
        ),

        migrations.AddField(
            model_name='documenttype',
            name='fields',
            field=models.ManyToManyField(blank=True, related_name='field_document_type',
                                         through='document.DocumentTypeField', to='document.DocumentField'),
        ),
    ]
